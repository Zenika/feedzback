"use strict";(self.webpackChunkfeedzback_docs=self.webpackChunkfeedzback_docs||[]).push([[102],{578:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var s=n(4848),t=n(8453);const l={},r="CircleCI",o={id:"ci-cd/circle-ci",title:"CircleCI",description:"Pre-requisites",source:"@site/docs/ci-cd/circle-ci.md",sourceDirName:"ci-cd",slug:"/ci-cd/circle-ci",permalink:"/feedzback/docs/ci-cd/circle-ci",draft:!1,unlisted:!1,editUrl:"https://github.com/Zenika/feedzback/tree/main/docusaurus/docs/ci-cd/circle-ci.md",tags:[],version:"current",frontMatter:{},sidebar:"default",previous:{title:"Quick start",permalink:"/feedzback/docs/ci-cd/quick-start"}},c={},d=[{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"Firebase &amp; co",id:"firebase--co",level:3},{value:"GCP APIs to enable",id:"gcp-apis-to-enable",level:3},{value:"Service account setup",id:"service-account-setup",level:3},{value:"Google Artifact repository",id:"google-artifact-repository",level:3},{value:"Domain mapping",id:"domain-mapping",level:3},{value:"IAM",id:"iam",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"App Settings",id:"app-settings",level:3},{value:"FEEDZBACK_CLIENT_URL",id:"feedzback_client_url",level:4},{value:"Google Cloud Platfom Settings",id:"google-cloud-platfom-settings",level:3},{value:"GCLOUD_SERVICE_KEY",id:"gcloud_service_key",level:4},{value:"GOOGLE_COMPUTE_ZONE",id:"google_compute_zone",level:4},{value:"GOOGLE_PROJECT_ID",id:"google_project_id",level:4},{value:"Firebase Settings",id:"firebase-settings",level:3},{value:"FIREBASE_TOKEN",id:"firebase_token",level:4},{value:"FIREBASE_CLIENT_EMAIL / Firebase Client Email",id:"firebase_client_email--firebase-client-email",level:4},{value:"FIREBASE_PRIVATE_KEY / Firebase Private Key",id:"firebase_private_key--firebase-private-key",level:4},{value:"FIREBASE_PROJECT_ID / Firebase Project ID",id:"firebase_project_id--firebase-project-id",level:4},{value:"Mailgun Settings",id:"mailgun-settings",level:3},{value:"MAILGUN_URL",id:"mailgun_url",level:3},{value:"MAILGUN_USERNAME",id:"mailgun_username",level:4},{value:"MAILGUN_KEY",id:"mailgun_key",level:4},{value:"MAILGUN_DOMAIN",id:"mailgun_domain",level:4},{value:"Crypto settings",id:"crypto-settings",level:3},{value:"CRYPTO_SECRET_KEY &amp; CRYPTO_SECRET_IV",id:"crypto_secret_key--crypto_secret_iv",level:4},{value:"Node Settings",id:"node-settings",level:3},{value:"NODE_ENV",id:"node_env",level:4},{value:"LINKS",id:"links",level:2}];function a(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.h1,{id:"circleci",children:"CircleCI"}),"\n",(0,s.jsx)(i.h2,{id:"pre-requisites",children:"Pre-requisites"}),"\n",(0,s.jsx)(i.h3,{id:"firebase--co",children:"Firebase & co"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"The Firebase project must be created."}),"\n",(0,s.jsx)(i.li,{children:"A Firestore database must be defined in the project."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"gcp-apis-to-enable",children:"GCP APIs to enable"}),"\n",(0,s.jsx)(i.p,{children:"The following APIs must be enabled on the linked GCP Project (which is automatically created when you create a firebase project):"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/apis/library/cloudbuild.googleapis.com",children:"Cloud Build API"})}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/apis/library/run.googleapis.com",children:"Cloud Run API"})}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"service-account-setup",children:"Service account setup"}),"\n",(0,s.jsxs)(i.p,{children:["A specific service account to build and deploy needs to exist on the project (used ",(0,s.jsx)(i.a,{href:"#gcloud_service_key",children:"here"}),")."]}),"\n",(0,s.jsx)(i.h3,{id:"google-artifact-repository",children:"Google Artifact repository"}),"\n",(0,s.jsxs)(i.p,{children:["The GCP Project needs to have a Docker ",(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/artifacts",children:"Google Artifact Repository"})," created named ",(0,s.jsx)(i.code,{children:"builds"})," for the CI to work properly."]}),"\n",(0,s.jsx)(i.h3,{id:"domain-mapping",children:"Domain mapping"}),"\n",(0,s.jsxs)(i.p,{children:["This can be done after a first deployment: through ",(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/run/domains",children:"Domain mappings in GCP"})," (for the server), and Firebase console (for the client)."]}),"\n",(0,s.jsx)(i.h3,{id:"iam",children:"IAM"}),"\n",(0,s.jsx)(i.p,{children:"It requires a few privileges as well:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Artifact Registry Writer"}),"\n",(0,s.jsx)(i.li,{children:"Cloud Build Service Account"}),"\n",(0,s.jsx)(i.li,{children:"Cloud Run Admin"}),"\n",(0,s.jsx)(i.li,{children:"Firebase Hosting Admin"}),"\n",(0,s.jsx)(i.li,{children:"Project Editor (aka Basic > Editor)"}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,s.jsx)(i.p,{children:"Environment variables are provided by a CircleCI Context (feedzback-staging for staging, feedzback-production for production)."}),"\n",(0,s.jsx)(i.h3,{id:"app-settings",children:"App Settings"}),"\n",(0,s.jsx)(i.h4,{id:"feedzback_client_url",children:"FEEDZBACK_CLIENT_URL"}),"\n",(0,s.jsx)(i.p,{children:"This helps the server compose URLs to include in emails."}),"\n",(0,s.jsx)(i.h3,{id:"google-cloud-platfom-settings",children:"Google Cloud Platfom Settings"}),"\n",(0,s.jsx)(i.p,{children:"These settings are used to build and deploy the server on the GCP Project as a Google Cloud Run managed service."}),"\n",(0,s.jsx)(i.h4,{id:"gcloud_service_key",children:"GCLOUD_SERVICE_KEY"}),"\n",(0,s.jsx)(i.p,{children:"Full JSON service key linked to the Service Account allowed to build and run the server on the GCP Project.\nIt is also used as the main authentication method for the firebase CLI during client deployment as FIREBASE_TOKEN usage will be decomissioned in the next major version."}),"\n",(0,s.jsx)(i.h4,{id:"google_compute_zone",children:"GOOGLE_COMPUTE_ZONE"}),"\n",(0,s.jsx)(i.p,{children:"Default compute zone to use (europe-west1 usually)."}),"\n",(0,s.jsx)(i.h4,{id:"google_project_id",children:"GOOGLE_PROJECT_ID"}),"\n",(0,s.jsx)(i.p,{children:"Self-reference to the Project (used by the CircleCI orb to properly handle resources)."}),"\n",(0,s.jsx)(i.h3,{id:"firebase-settings",children:"Firebase Settings"}),"\n",(0,s.jsx)(i.h4,{id:"firebase_token",children:"FIREBASE_TOKEN"}),"\n",(0,s.jsxs)(i.p,{children:["Token used only by CI to connect to Firebase and deploy the client. Was generated following this ",(0,s.jsx)(i.a,{href:"https://firebase.google.com/docs/cli?authuser=0#cli-ci-systems",children:"documentation"})]}),"\n",(0,s.jsx)(i.h4,{id:"firebase_client_email--firebase-client-email",children:"FIREBASE_CLIENT_EMAIL / Firebase Client Email"}),"\n",(0,s.jsx)(i.p,{children:"Identifier used to authenticate against the Firebase stack. Found in the firebase console."}),"\n",(0,s.jsx)(i.h4,{id:"firebase_private_key--firebase-private-key",children:"FIREBASE_PRIVATE_KEY / Firebase Private Key"}),"\n",(0,s.jsx)(i.p,{children:"A Service Account must be defined with the proper key. The private key used in the FIREBASE_PRIVATE_KEY environment variable needs to be base64 encoded."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Using bash:"}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:'echo "content_of_private_key_field_in_json_key" | base64\n'})}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Using Node.js:"}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-js",children:"Buffer.from('content_of_private_key_field_in_json_key').toString('base64');\n"})}),"\n",(0,s.jsx)(i.h4,{id:"firebase_project_id--firebase-project-id",children:"FIREBASE_PROJECT_ID / Firebase Project ID"}),"\n",(0,s.jsx)(i.p,{children:"Identifier of the Firebase project."}),"\n",(0,s.jsx)(i.h3,{id:"mailgun-settings",children:"Mailgun Settings"}),"\n",(0,s.jsxs)(i.p,{children:["These are injected in the Cloud Run container in order to properly use Mailgun to send emails and notifications.\nOn staging, a sandbox account is used that redirects any sent email to ",(0,s.jsx)(i.a,{href:"mailto:feedzback@zenika.com",children:"feedzback@zenika.com"}),"."]}),"\n",(0,s.jsx)(i.h3,{id:"mailgun_url",children:"MAILGUN_URL"}),"\n",(0,s.jsx)(i.p,{children:"The mailgun endpoint to use to connect to mailgun sending server."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["for sandbox mailgun account: ",(0,s.jsx)(i.code,{children:"https://api.mailgun.net"})]}),"\n",(0,s.jsxs)(i.li,{children:["for production account (which is in EU): ",(0,s.jsx)(i.code,{children:"https://api.eu.mailgun.net"})]}),"\n"]}),"\n",(0,s.jsx)(i.h4,{id:"mailgun_username",children:"MAILGUN_USERNAME"}),"\n",(0,s.jsx)(i.p,{children:"The Mailgun API username (needs to match the domain of the key)."}),"\n",(0,s.jsx)(i.h4,{id:"mailgun_key",children:"MAILGUN_KEY"}),"\n",(0,s.jsx)(i.p,{children:"An API secret defined on the mailgun platform that allows to send email."}),"\n",(0,s.jsx)(i.h4,{id:"mailgun_domain",children:"MAILGUN_DOMAIN"}),"\n",(0,s.jsxs)(i.p,{children:["The domain associated with the account.\nUse the sandbox username as the domain (",(0,s.jsx)(i.code,{children:"sandbox8d21179029774bb29c92557ea6ab0d88.mailgun.org"}),").\nIn production should be ",(0,s.jsx)(i.code,{children:"feedzback.znk.io"}),"."]}),"\n",(0,s.jsx)(i.h3,{id:"crypto-settings",children:"Crypto settings"}),"\n",(0,s.jsx)(i.h4,{id:"crypto_secret_key--crypto_secret_iv",children:"CRYPTO_SECRET_KEY & CRYPTO_SECRET_IV"}),"\n",(0,s.jsx)(i.p,{children:"Used to encrypt/decrypt feedback sensitives data in the Firestore database."}),"\n",(0,s.jsxs)(i.p,{children:["In staging set their values to: ",(0,s.jsx)(i.code,{children:"feedzback"}),"."]}),"\n",(0,s.jsx)(i.h3,{id:"node-settings",children:"Node Settings"}),"\n",(0,s.jsx)(i.h4,{id:"node_env",children:"NODE_ENV"}),"\n",(0,s.jsxs)(i.p,{children:["Should be ",(0,s.jsx)(i.code,{children:"production"})," for production environment, otherwise all mails will be sent to ",(0,s.jsx)(i.a,{href:"mailto:feedzback@zenika.com",children:"feedzback@zenika.com"}),"."]}),"\n",(0,s.jsx)(i.h2,{id:"links",children:"LINKS"}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"ENVIRONMENT"}),(0,s.jsx)(i.th,{children:"FIREBASE PROJECT"}),(0,s.jsx)(i.th,{children:"GCP PROJECT"}),(0,s.jsx)(i.th,{children:"CIRCLECI CONTEXT"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"\ud83d\udea7 staging"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://console.firebase.google.com/project/feedzback-v2-staging/overview",children:"Console"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/home/dashboard?hl=en&project=feedzback-v2-staging",children:"Console"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://app.circleci.com/settings/organization/github/Zenika/contexts/489bddb3-fe2e-465e-91f9-b9ba7a155e0d?return-to=%2F",children:"Context"})})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"\ud83c\udfac production"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://console.firebase.google.com/project/feedzback-v2/overview",children:"Console"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://console.cloud.google.com/home/dashboard?hl=en&project=feedzback-v2",children:"Console"})}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.a,{href:"https://",children:"Context"})})]})]})]})]})}function h(e={}){const{wrapper:i}={...(0,t.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>r,x:()=>o});var s=n(6540);const t={},l=s.createContext(t);function r(e){const i=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(l.Provider,{value:i},e.children)}}}]);