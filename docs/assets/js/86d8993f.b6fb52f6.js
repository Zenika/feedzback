"use strict";(globalThis.webpackChunkfeedzback_docs=globalThis.webpackChunkfeedzback_docs||[]).push([[56],{4568(e,s,n){n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"business-cases/pre-request-feedback","title":"Pre-request feedback with magic link","description":"User story","source":"@site/docs/business-cases/pre-request-feedback.md","sourceDirName":"business-cases","slug":"/business-cases/pre-request-feedback","permalink":"/feedzback/docs/business-cases/pre-request-feedback","draft":false,"unlisted":false,"editUrl":"https://github.com/Zenika/feedzback/tree/main/docs-source/docs/business-cases/pre-request-feedback.md","tags":[],"version":"current","frontMatter":{},"sidebar":"default","previous":{"title":"Request feedback","permalink":"/feedzback/docs/business-cases/request-feedback"},"next":{"title":"Reply to feedback request","permalink":"/feedzback/docs/business-cases/reply-to-feedback-request"}}');var r=n(4848),t=n(8453);const c={},l="Pre-request feedback with magic link",d={},a=[{value:"User story",id:"user-story",level:2},{value:"Technical specifications",id:"technical-specifications",level:2},{value:"Magic link generation workflow",id:"magic-link-generation-workflow",level:3},{value:"Firestore schema",id:"firestore-schema",level:3},{value:"Magic link format",id:"magic-link-format",level:3},{value:"Magic link usage workflow",id:"magic-link-usage-workflow",level:3},{value:"Token constraints",id:"token-constraints",level:3},{value:"Links",id:"links",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"pre-request-feedback-with-magic-link",children:"Pre-request feedback with magic link"})}),"\n",(0,r.jsx)(s.h2,{id:"user-story",children:"User story"}),"\n",(0,r.jsx)(s.p,{children:'As a Zenika employee, I would like to request feedback from colleagues when I don\'t know their email addresses upfront. Instead of specifying individual emails, I can generate a shareable "magic link" that colleagues can use to provide their email address and trigger a feedback request.'}),"\n",(0,r.jsx)(s.p,{children:"This is particularly useful when:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"I want to share the request in a Slack channel or Teams group"}),"\n",(0,r.jsx)(s.li,{children:"My colleagues' company blocks emails sent via Mailgun. However, they can still give me feedback using their personal email addresses, which I don't know in advance."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Once a colleague uses the magic link and provides their email, they receive a feedback request email just like in the standard feedback request workflow."}),"\n",(0,r.jsx)(s.h2,{id:"technical-specifications",children:"Technical specifications"}),"\n",(0,r.jsxs)(s.p,{children:["Be sure to read ",(0,r.jsx)(s.a,{href:"./request-feedback",children:"Request feedback"})," first, as this feature is an enhancement of that workflow."]}),"\n",(0,r.jsx)(s.h3,{id:"magic-link-generation-workflow",children:"Magic link generation workflow"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["The requester (authenticated user) navigates to ",(0,r.jsx)(s.code,{children:"/request"})]}),"\n",(0,r.jsxs)(s.li,{children:["Selects ",(0,r.jsx)(s.strong,{children:'"With a magic link"'})," method"]}),"\n",(0,r.jsx)(s.li,{children:"Fills and Submits the form (the recipients field is disabled for this method)"}),"\n",(0,r.jsxs)(s.li,{children:["Client calls ",(0,r.jsx)(s.code,{children:"POST /feedback/pre-request/token"})]}),"\n",(0,r.jsxs)(s.li,{children:["Server creates a document in the ",(0,r.jsx)(s.code,{children:"feedbackPreRequestToken"})," collection and returns ",(0,r.jsx)(s.code,{children:"{ token: string }"})]}),"\n",(0,r.jsx)(s.li,{children:"Client navigates to the success page displaying the magic link"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"The requester can copy this link and share it through any channel (Slack, Teams, email, etc.)."}),"\n",(0,r.jsx)(s.h3,{id:"firestore-schema",children:"Firestore schema"}),"\n",(0,r.jsxs)(s.p,{children:["A document is added in the ",(0,r.jsx)(s.code,{children:"feedbackPreRequestToken"})," collection to store magic link tokens:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const preRequestToken: FeedbackPreRequestToken = {\n  receiverEmail: 'pinocchio@zenika.com', // Who will receive the feedback\n  message: 'Hi team, please share your feedback...', // Encrypted\n  shared: true, // Whether to share with manager\n  expiresAt: 1711662999463, // Timestamp\n  usedBy: ['gimini@gmail.com', 'gepetto@gmail.com'], // Emails that used this token\n};\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"The document ID is the token itself (auto-generated by Firestore)."}),"\n",(0,r.jsxs)(s.li,{children:["The ",(0,r.jsx)(s.code,{children:"usedBy"})," array tracks which emails have already used this token"]}),"\n",(0,r.jsx)(s.li,{children:"Each use of the token triggers a separate feedback request"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"magic-link-format",children:"Magic link format"}),"\n",(0,r.jsxs)(s.p,{children:["The magic link format is: ",(0,r.jsx)(s.code,{children:"{origin}/pre-request/token/{token}"})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Example:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-txt",children:"https://feedzback.znk.io/pre-request/token/abc123xyz\n"})}),"\n",(0,r.jsxs)(s.p,{children:["The magic link does not contain the locale.\nThe redirection to ",(0,r.jsx)(s.code,{children:"/fr"})," or ",(0,r.jsx)(s.code,{children:"/en"})," occurs when the colleague visits the magic link page (see ",(0,r.jsx)(s.code,{children:"src/404.html"})," for details)."]}),"\n",(0,r.jsxs)(s.p,{children:["However, since this redirection is not functional in the ",(0,r.jsx)(s.code,{children:"dev-local"})," environment, the locale is explicitly added only in this case."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsxs)(s.strong,{children:["Example in ",(0,r.jsx)(s.code,{children:"dev-local"})," environment:"]})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-txt",children:"https://feedzback.znk.io/fr/pre-request/token/abc123xyz\n"})}),"\n",(0,r.jsx)(s.h3,{id:"magic-link-usage-workflow",children:"Magic link usage workflow"}),"\n",(0,r.jsx)(s.p,{children:"When a colleague accesses the magic link:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["The colleague (not authenticated) visits ",(0,r.jsx)(s.code,{children:"/pre-request/token/{token}"})]}),"\n",(0,r.jsxs)(s.li,{children:["The colleague's browser redirects to the appropriate locale (example: ",(0,r.jsx)(s.code,{children:"/fr/pre-request/token/{token}"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:["Client calls ",(0,r.jsx)(s.code,{children:"GET /feedback/check-pre-request/{token}"})," to validate the token"]}),"\n",(0,r.jsx)(s.li,{children:"If valid, the page displays the details of the pre-request and a form field allowing the colleague to enter their email address"}),"\n",(0,r.jsx)(s.li,{children:"The colleague enters their email and submits"}),"\n",(0,r.jsxs)(s.li,{children:["Client calls ",(0,r.jsx)(s.code,{children:"POST /feedback/pre-request/email"})," with ",(0,r.jsx)(s.code,{children:"{ token, recipient }"})]}),"\n",(0,r.jsxs)(s.li,{children:["Server validates the token and email, then:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Adds the email to the ",(0,r.jsx)(s.code,{children:"usedBy"})," array in ",(0,r.jsx)(s.code,{children:"feedbackPreRequestToken"})," document"]}),"\n",(0,r.jsxs)(s.li,{children:["Triggers the standard feedback request workflow:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Creates ",(0,r.jsx)(s.code,{children:"feedback"})," and ",(0,r.jsx)(s.code,{children:"feedbackRequestToken"})," documents"]}),"\n",(0,r.jsx)(s.li,{children:"Sends a feedback request email to the colleague"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.li,{children:"Client navigates to a success page confirming the email was sent"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["From this point forward, the flow is identical to the standard ",(0,r.jsx)(s.a,{href:"./reply-to-feedback-request",children:"Reply to feedback request"})," workflow."]}),"\n",(0,r.jsx)(s.h3,{id:"token-constraints",children:"Token constraints"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Expiration"})," configured via ",(0,r.jsx)(s.code,{children:"FEEDBACK_PRE_REQUEST_EXPIRATION_IN_DAYS"})," constant (3 days)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Maximum uses"})," configured via ",(0,r.jsx)(s.code,{children:"FEEDBACK_PRE_REQUEST_MAX_USES"})," constant (10 uses per token)"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"When a colleague attempts to use a magic link, the following checks are performed:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Validation"}),(0,r.jsx)(s.th,{children:"Error Type"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Token exists"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"token_invalid"})}),(0,r.jsx)(s.td,{children:"The token doesn't exist in the database"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Not expired"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"token_expired"})}),(0,r.jsxs)(s.td,{children:["The current time exceeds ",(0,r.jsx)(s.code,{children:"expiresAt"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Under max uses"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"token_max_uses_reached"})}),(0,r.jsxs)(s.td,{children:["The ",(0,r.jsx)(s.code,{children:"usedBy"})," array length has reached the limit"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Email not used"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"recipient_already_used"})}),(0,r.jsxs)(s.td,{children:["The email is already in the ",(0,r.jsx)(s.code,{children:"usedBy"})," array"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Not self-request"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"recipient_forbidden"})}),(0,r.jsxs)(s.td,{children:["The email matches the ",(0,r.jsx)(s.code,{children:"receiverEmail"})]})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["If any validation fails, a ",(0,r.jsx)(s.code,{children:"BadRequestException"})," or ",(0,r.jsx)(s.code,{children:"ForbiddenException"})," is thrown with the corresponding error type."]}),"\n",(0,r.jsx)(s.h2,{id:"links",children:"Links"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Client"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://github.com/Zenika/feedzback/blob/main/client/src/app/request-feedback/request-feedback.component.ts",children:(0,r.jsx)(s.code,{children:"RequestFeedbackComponent"})})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://github.com/Zenika/feedzback/blob/main/client/src/app/pre-request-feedback/pre-request-feedback.component.ts",children:(0,r.jsx)(s.code,{children:"PreRequestFeedbackComponent"})})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Server"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"https://github.com/Zenika/feedzback/blob/main/server/src/feedback/feedback.controller.ts",children:(0,r.jsx)(s.code,{children:"FeedbackController"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"preRequestToken"})," - Creates pre-request token"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"checkPreRequest"})," - Validates token and returns details"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"preRequestEmail"})," - Processes email submission and triggers feedback request"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,s,n){n.d(s,{R:()=>c,x:()=>l});var i=n(6540);const r={},t=i.createContext(r);function c(e){const s=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(t.Provider,{value:s},e.children)}}}]);